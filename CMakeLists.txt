cmake_minimum_required(VERSION 3.13)

project(nftp-codec)

option(DEBUG "This is a default option for DEBUG" ON)
option(TEST "This is a default option for EXAMPLE" ON)
option(HASHTABLE "This is a default option for HASHTABLE" ON)

if(DEBUG)
  set(CMAKE_BUILD_TYPE "Debug")
  if(APPLE)
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -g -fsanitize=address")
  else()
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -g -fsanitize=address -fsanitize=leak")
  endif()
  add_definitions(-DDEBUG)
endif(DEBUG)

if (HASHTABLE)
  add_subdirectory(hashtable)
endif()

set(SOURCES 
  src/file.c
  src/hash.c
  src/iovs.c
  src/codec.c
  src/proto.c
  src/nftp.h
)

include_directories(${CMAKE_CURRENT_SOURCE_DIR}/src)
include_directories(${CMAKE_CURRENT_SOURCE_DIR}/hashtable)

add_library(nftp-codec ${SOURCES})

if(TEST)
  add_executable(test
	  test/test.c
	  test/hash.c
	  test/file.c
	  test/iovs.c
	  test/codec.c)
  target_link_libraries(test nftp-codec hashtable)
endif(TEST)

if(NOT DEBUG)
  target_compile_options(nftp-codec PUBLIC -O3 -Os -g)
endif()
